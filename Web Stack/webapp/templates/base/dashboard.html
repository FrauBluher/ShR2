<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Dashboard</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<div class="row">
    <div class="col-lg-12">
        {% if my_devices %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i>
                   {{ my_devices.0.name }} at a glance
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                            Change Device
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu pull-right" role="menu">
                            {% for device in my_devices %}
                            <li><a class="chart-device" id="{{device.serial}}" href="javascript:void(0)">{{device.name}}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div id="line-chart"></div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
        {% else %}
        <h4>You have no registered devices. <a href="javascrtipt:void(0)" data-toggle="modal" data-target="#deviceModal">Click Here</a> to register a new device</h4>
        {% endif %}
    </div>
    <!-- /.col-lg-8 -->
</div>
<!-- /.row -->
<script type="text/javascript">
   
   //initial chart load, get data for first device
   {% if my_devices %}
     
     chart = new TimeChart({
        container: document.getElementById("line-chart"),
        data:
        {
            units:["y","M","d","h","m","s"],
            timestampInSeconds: true,
            urlByUnit:{
               "m":"/charts/device/{{ my_devices.0.serial }}/",
               "M":"/charts/device/{{ my_devices.0.serial }}/",
               "d":"/charts/device/{{ my_devices.0.serial }}/",
               "h":"/charts/device/{{ my_devices.0.serial }}/",
               "y":"/charts/device/{{ my_devices.0.serial }}/",
               "s":"/charts/device/{{ my_devices.0.serial }}/",
            }
        },
        legend: { enabled: true },
        valueAxis:{
           "default":{
              title: "Power (W)"
           }
        },
        series:[
            {
              name: "Total",
              id: "total",
              type:"line",
              data:{
                index:1,
                aggregation:"avg",
                noDataPolicy:"skip"
              },
              style:{
                lineWidth: 1,
                smoothing: true
              }
            },
           {% for appliance in appliances %}
           {
              name: "{{ appliance }}",
              id:"event{{ forloop.counter }}",
              type:"line",
              data:{
                 index:{{ forloop.counter }}+1,
                 aggregation:"avg",
                 noDataPolicy:"skip"
              },
              stack: "default",
              style:{
                 fillColor:"{% if appliance == 'Unknown' %}grey{% else %}{% cycle 'red' 'blue' 'green' 'purple' 'cyan' 'yellow' 'orange' %}{% endif %}",
                 lineColor:""
              }
           },
           {% endfor %}
        ],
        area: {
           initialDisplayUnit: "1 s",
           initialDisplayPeriod: "1 d",
           initialDisplayAnchor: "newestData",
           followAnchor: true,
        },
        advanced:{timeUpdateInterval: 300},
     });
   {% endif %}

function realTimeData() {
   var interval = chart.displayUnit().split(' ')[0];
   var displayUnit = chart.displayUnit().slice(-1);
   var period;
   var timeout;
   if (displayUnit == 'm') {
      period = 'now - ' + interval + ' minutes'
      timeout = interval * 60 * 900
   }
   else if (displayUnit == 's') {
      period = 'now - ' + interval + ' seconds'
      timeout = interval * 900
   }
   else {
      // Update everything on the hour. Fix later.
      period = 'now - ' + interval + ' hours'
      timeout = interval * 60 * 60 * 900
   }
   var start = +Date.parse(period);
   var stop = +Date.parse('now');
   var get_url = '/charts/device/{{ my_devices.0.serial }}/?unit='+displayUnit+'&from='+start+'&to='+stop;
   $.get(get_url, function (ajax_data) {
      console.log(ajax_data);
      chart.addData({unit: displayUnit, values: ajax_data.data});
   });
   setTimeout(realTimeData, timeout);
}

function waitForChart() {
   console.log("Waiting for chart");
   if (chart.displayUnit() != null) {
      realTimeData();
   } else {
      setTimeout(waitForChart, 250);
   }
}

$(function() {
   waitForChart();
});

</script>
