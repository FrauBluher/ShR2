<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Dashboard</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<div class="row">
    <div class="col-lg-12">
        {% if my_devices %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i>
                   {{ my_devices.0.name }} at a glance
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                            Change Device
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu pull-right" role="menu">
                            {% for device in my_devices %}
                            <li><a class="chart-device" id="{{device.serial}}" href="javascript:void(0)">{{device.name}}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div id="line-chart"></div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
        {% else %}
        <h4>You have no registered devices. <a href="javascrtipt:void(0)" data-toggle="modal" data-target="#deviceModal">Click Here</a> to register a new device</h4>
        {% endif %}
    </div>
    <!-- /.col-lg-8 -->
</div>
<!-- /.row -->
<script type="text/javascript">
   //sidebar devices links
   $('.selected').each(function() {
        $(this).on("click", function() {
            $('#content').empty();
            var url = '/charts/device/'+$(this).attr('id');
            var container = document.getElementById("content");
            var device_name = $(this).html();
            //make_chart(url, container, "Power (W)", device_name)
        });
    }); 
   
   //chart devices links
   $('.chart-device').each(function() {
		$(this).on("click", function() {
            var url = '/charts/device/'+$(this).attr('id');
            var container = document.getElementById("line-chart");
            var device_name = $(this).html();
            //make_chart(url, container, "Power (W)", device_name)
	   });
    });

   //initial dashboard load
   $('#dashboard').on("click", function() {
      $.get("/dashboard/", function( ajax_data ) {
         $('#content').html(ajax_data);
      });
   });
   
   //initial chart load, get data for first device
   {% if my_devices %}
     chart = new TimeChart({
        container: document.getElementById("line-chart"),
        data:
        {
            dataFunction: function(from, to, unit, success, error){
                $.get("/charts/device/{{ my_devices.0.serial }}/"+unit,null,function(data){
                    success(data);
                    console.log(data);
                });
            }
        },
        legend: { enabled: true },
        valueAxis:{
           "default":{
              title: "Power (W)"
           }
        },
        series:[
            {
              name: "Total",
              id: "total",
              type:"line",
              data:{
                index:1,
                aggregation:"avg"
              },
              style:{
                lineWidth: 2,
                smoothing: true
              }
            },
           {% for appliance in appliances %}
           {
              name: {% if appliance == None %}
                        "Unknown",
                    {% else %}
                        "{{ appliance }}",
                    {% endif %}
              id:"event{{ forloop.counter }}",
              type:"line",
              data:{
                 index:{{ forloop.counter }}+1,
                 aggregation:"avg"
              },
              stack: "default",
              style:{
                 fillColor:"{% cycle 'red' 'blue' 'green' 'purple' %}"
              }
           },
           {% endfor %}
        ],
        area: {
           initialDisplayUnit: "5 m",
           initialDisplayPeriod: "1 d",
           initialDisplayAnchor: "newestData"
        },
        currentTime: {enabled: false},
        
     });
   {% endif %}

</script>
