

<div class="row">
   <div style="height:400px; width:100%;" id="map-canvas"></div>
   <button id="map-slide-toggle" style="width:100%;"type="button" class="btn btn-default" aria-label="Left-Align">
      <span id="map-slide-icon" class="glyphicon glyphicon-menu-up" aria-hidden="true"></span>
   <span id="map-slide-text">Hide Map</span>
   </button>
</div>

<div class="row">
    <div class="col-lg-12">
        {% if my_devices %}
        <div class="panel panel-default">
            <div class="panel-heading">
               <div id='chart-title' value='{{ my_devices.0.serial }}'>{{ my_devices.0.name }} at a glance</div>
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                            Change Chart Type
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu pull-right" role="menu">
                            <li><a class="chart-stack" id="stack" href='javascript:refresh_chart(true)'>Stacked</a></li>
                            <li><a class="chart-stack" id="unstack" href='javascript:refresh_chart(false)'>Unstacked</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div id="line-chart"></div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
        {% else %}
        <h4>You have no registered devices. <a href="javascrtipt:void(0)" data-toggle="modal" data-target="#deviceModal">Click Here</a> to register a new device</h4>
        {% endif %}
    </div>
    <!-- /.col-lg-8 -->
    <div id='ajax-container'></div>
</div>
<!-- /.row -->

<script>

var device_serial;

$(function() {
  device_serial = {{ my_devices.0.serial }}
});

function refresh_chart(stack) {
  var device_name = $('#chart-title').html().split(' at a glance')[0]
  $.get('/charts/device/'+device_serial+'/chart/',
    {
      'stack': stack,
      'localtime': +(new Date()/1000),
    },
    function(data) {
      $('#ajax-container').html(data);
      render_chart();
      $('#chart-title').html(device_name+" at a glance");
    }
  );
}

var contentArray = {}
{% for device in my_devices %}
contentArray['{{ device.serial }}'] = '';
var marker{{ device.serial }};
var infowindow{{ device.serial }};

{% endfor %}

function get_wattage_usage() {
   {% for device in my_devices %}
    $.get('/device/get_wattage_usage/',
        { serial: {{ device.serial }} },
        function(data) {
           var current_wattage, average_wattage;
           if (data.average_wattage > data.current_wattage) {
              current_wattage = '<p><strong>Current Usage:</strong><span style="color: green;" id="current-wattage-{{ device.serial }}">'+data.current_wattage+'</span></p>'
           } else {
              current_wattage = '<p><strong>Current Usage:</strong><span style="color: red;" id="current-wattage-{{ device.serial }}">'+data.current_wattage+'</span></p>'
              
           }
           average_wattage = '<p><strong>Average Usage:</strong><span id=average-wattage-{{ device.serial }}>'+data.average_wattage+'</span></p>'
           contentArray['{{ device.serial }}'] = '<div id="content"><h3 id="device-name">{{ device.name }}</h3><div id="body-content-{{ device.serial }}">'+ average_wattage +'<p><strong>Average Cost:</strong>$???</p>'+ current_wattage +'</div></div>';
           infowindow{{ device.serial }} = new google.maps.InfoWindow({
            content: contentArray['{{ device.serial }}']
           });
           {% if forloop.first %}
           infowindow{{ device.serial }}.open(map, marker{{ device.serial }});
           {% endif %}

           google.maps.event.addListener(marker{{ device.serial }}, 'click', function() {
             {% for device2 in my_devices %}
              infowindow{{ device2.serial }}.close();
             {% endfor %}
             infowindow{{ device.serial }}.open(map, marker{{ device.serial }});
             $.get('/charts/device/{{ device.serial }}/chart/',
               {
                'stack': true,
                'localtime': +(new Date)/1000,
               },
               function(data) {
                 $('#ajax-container').html(data);
                 render_chart();
                 $('#chart-title').html("{{ device.name }} at a glance");
                 $('#chart-title').val("{{ device.serial }}");
                 device_serial = {{ device.serial }};
               }
             );
           });
        }
     );
   {% endfor %}
}

var map_open = true;

$(function() {
   get_wattage_usage();
   initialize();
   $('#map-slide-toggle').on('click', function() {
      if (map_open) {
         $('#map-canvas').slideUp();
         $('#map-slide-text').html('Show Map');
         $('#map-slide-icon').removeClass('glyphicon-menu-up');
         $('#map-slide-icon').addClass('glyphicon-menu-down')
      } else {
         $('#map-canvas').slideDown();
         $('#map-slide-text').html('Hide Map');
         $('#map-slide-icon').removeClass('glyphicon-menu-down');
         $('#map-slide-icon').addClass('glyphicon-menu-up');
      }
      map_open = !map_open;
   });
});

var map, placeSearch, autocomplete;

function initialize() {
  var mapOptions = {
    scrollwheel: false,
    zoom: 17
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
      
   var LatLngList = new Array ();

  {% for device in my_devices %}
     var pos = new google.maps.LatLng({{ device.position }});
     LatLngList.push(pos);

     marker{{ device.serial }} = new google.maps.Marker({
       map: map,
       position: pos,
       title: '{{ device.name }}',
       label: '{{ device.name }}',
     });

     

  {% endfor %}
  
   new DayNightOverlay({
      map: map
   });

   var bounds = new google.maps.LatLngBounds ();
   //  Go through each...
   for (var i = 0, LtLgLen = LatLngList.length; i < LtLgLen; i++) {
      //  And increase the bounds to take this point
      bounds.extend (LatLngList[i]);
   }
   //  Fit these bounds to the map
   map.fitBounds (bounds);
}
</script>
