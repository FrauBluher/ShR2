<div class="row" style="margin-top:20px;">
   <div style="height:500px; width:100%" id="map-canvas"></div>
</div>

<div class="row">
    <div class="col-lg-12">
        {% if my_devices %}
        <div class="panel panel-default">
            <div class="panel-heading">
               <div id='chart-title'>{{ my_devices.0.name }} at a glance</div>
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                            Change Device
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu pull-right" role="menu">
                            {% for device in my_devices %}
                            <li><a class="chart-device" id="{{device.serial}}" href='javascript:change_device({{ device.serial }},"{{ device.name }}")'>{{device.name}}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div id="line-chart"></div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
        {% else %}
        <h4>You have no registered devices. <a href="javascrtipt:void(0)" data-toggle="modal" data-target="#deviceModal">Click Here</a> to register a new device</h4>
        {% endif %}
    </div>
    <!-- /.col-lg-8 -->
    <div id='ajax-container'></div>
</div>
<!-- /.row -->

<script>
function change_device(serial, name) {
   $.get('/charts/device/'+serial+'/chart/',
      function(data) {
         $('#ajax-container').html(data);
         render_chart();
         $('#chart-title').html(name+" at a glance");
      }
   );
};

$(function() {
   $.get('/charts/device/{{ my_devices.0.serial }}/chart/',
      function(data) {
         $('#ajax-container').html(data);
         render_chart();
      }
   );
});
</script>

<script>
$(function() {
   initialize();
});

var map, placeSearch, autocomplete;

function initialize() {
  var mapOptions = {
    scrollwheel: false,
    zoom: 17
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
      
   var LatLngList = new Array ();

  {% for device in my_devices %}
     var pos = new google.maps.LatLng({{ device.position }});
     LatLngList.push(pos)
     var marker{{ device.serial }} = new google.maps.Marker({
       map: map,
       position: pos,
       title: '{{ device.name }}',
     });
     var content{{ device.serial }} = '\
         <div id="content">'+
            '<h3 id="device-name">{{ device.name }}</h3>'+
            '<div id="body-content">'+
               '<p>Average Usage: ??? W</p>'+
               '<p>Average Cost: $???</p>'+
               '<p>Current Usage: ??? W</p>'+
            '</div>'+
         '</div>';
     var infowindow{{ device.serial }} = new google.maps.InfoWindow({
        content: content{{ device.serial }}
     });
     google.maps.event.addListener(marker{{ device.serial }}, 'click', function() {
        {% for device2 in my_devices %}
           infowindow{{ device2.serial }}.close();
        {% endfor %}
        infowindow{{ device.serial }}.open(map, marker{{ device.serial }});
        $.get('/charts/device/{{ device.serial }}/chart/',
        function(data) {
           $('#ajax-container').html(data);
           render_chart();
           $('#chart-title').html("{{ device.name }} at a glance");
        }
   );
     });
  {% endfor %}
  
   new DayNightOverlay({
      map: map
   });

   var bounds = new google.maps.LatLngBounds ();
   //  Go through each...
   for (var i = 0, LtLgLen = LatLngList.length; i < LtLgLen; i++) {
      //  And increase the bounds to take this point
      bounds.extend (LatLngList[i]);
   }
   //  Fit these bounds to the map
   map.fitBounds (bounds);
}
</script>
